<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SolarEstimatePro</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css?family=Work+Sans:400,500,600,700&display=swap');

        * {
            font-family: 'Work Sans', sans-serif;
        }

        body {
            background-color: #f8f9fa;
        }

        header {
            background-color: #007BFF;
            color: #fff;
            text-align: center;
            padding: 2em;
        }

        /* .main.accordion {} */

        .card-header {
            background-color: #f8f9fa;
        }

        .card-header button {
            color: #007BFF;
            font-size: 0.9em;
        }

        /* Style the card bodies */
        .card-body {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-top: none;
        }

        /* Style the table */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        /* Style table headers */
        .table th {
            background-color: #007BFF;
            color: #fff;
            text-align: left;
            width: 25%;
        }

        /* Style table rows */
        .table td {
            border: 1px solid #dee2e6;
            font-size: 1.2em;
            text-align: center;
            font-family: monospace;
        }

        /* Style the "Download Energy Data" button */
        .btn-primary {
            background-color: #007BFF;
            border: none;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        /* Style the footer */
        footer {
            /* height: 3em; */
            /* position:fixed; */
            /* bottom: 0%; */
            width: 100%;
            text-align: center;
            background-color: #f8f9fa;
            padding: 1em;
        }

        .site-icon i {
            position: absolute;
            left: 1em;
            font-size: 6em;
            color: yellow;
        }

        .google-map {
            /* position: fixed !important; */
            height: 300px !important;
            width: 400px !important;
        }

        #step1Content {
            min-height: 500px;
        }
    </style>
</head>

<body>
    <header>
        <div class="site-icon"><i class="material-icons-outlined">brightness_7</i></div>
        <h1>Welcome to SolarEstimatePro</h1>
        <p>
            Estimate the energy production and savings of your solar PV system
        </p>
    </header>
    <main class="accordion" id="wizardAccordion">
        <!-- Step 1 -->
        <section class="card">
            <div class="card-header" id="step1Header">
                <h2>
                    <button class="btn btn-link collapsed" type="button" data-toggle="collapse"
                        data-target="#step1Content" aria-expanded="true" aria-controls="step1Content">
                        <i class="material-icons">location_on</i> Step 1: Choose your location
                    </button>
                </h2>
            </div>

            <div id="step1Content" class="collapse" aria-labelledby="step1Header" data-parent="#wizardAccordion">
                <div class="card-body">
                    <form id="location-form">
                        <div class="form-group">
                            <label for="location">Location</label>
                            <input type="text" class="form-control" id="location" value="SW1 1AA">
                            <input type="hidden" class="form-control" id="location_lat" value="55">
                            <input type="hidden" class="form-control" id="location_lng" value="0">
                            <button id="address-btn">Find</button>
                        </div>
                    </form>

                    <div id="location-map" class="google-map">
                        <img src="https://via.placeholder.com/400x300" alt="Placeholder Drawable Map">
                    </div>
                </div>
            </div>
            </div>

            <!-- Step 2 -->
            <section class="card">
                <div class="card-header" id="step2Header">
                    <h2>
                        <button class="btn btn-link collapsed" type="button" data-toggle="collapse"
                            data-target="#step2Content" aria-expanded="false" aria-controls="step2Content">
                            <i class="material-icons">map</i> Step 2: Choose your solar panel location and area
                        </button>
                    </h2>

                </div>
                <div id="step2Content" class="collapse" aria-labelledby="step2Header" data-parent="#wizardAccordion">
                    <div class="card-body">
                        <h3 id="area-result-heading">Area: 1,000m^2</h3>
                        <input id="area-result" type="hidden" value="1,000" />
                        <div id="drawable-map" class="google-map">
                            <img src="https://via.placeholder.com/400x300" alt="Placeholder Drawable Map">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 3 -->
            <section class="card">
                <div class="card-header" id="step3Header">
                    <h2>
                        <button class="btn btn-link collapsed" type="button" data-toggle="collapse"
                            data-target="#step3Content" aria-expanded="false" aria-controls="step3Content">
                            <i class="material-icons-outlined">settings</i> Step 3: Choose your panel and system
                            parameters
                        </button>
                    </h2>
                </div>
                <div id="step3Content" class="collapse" aria-labelledby="step3Header" data-parent="#wizardAccordion">
                    <div class="card-body">
                        <form id="estimate-form">
                            <div class="form-group">
                                <label for="capacity">System Capacity (kW)</label>
                                <input type="number" class="form-control" id="capacity" step="0.1">
                            </div>

                            <div class="form-group">
                                <label for="array-type">Array Type</label>
                                <input type="text" class="form-control" id="array-type">
                            </div>

                            <div class="form-group">
                                <label for="module-type">Module Type</label>
                                <input type="text" class="form-control" id="module-type">
                            </div>

                            <div class="form-group">
                                <label for="tilt">Tilt Angle (°)</label>
                                <input type="number" class="form-control" id="tilt">
                            </div>

                            <div class="form-group">
                                <label for="azimuth">Azimuth Angle (°)</label>
                                <input type="number" class="form-control" id="azimuth">
                            </div>

                            <div class="form-group">
                                <label for="losses">System Losses (%)</label>
                                <input type="number" class="form-control" id="losses">
                            </div>

                        </form>
                    </div>
                </div>
            </section>

            <!-- Step 4 -->
            <section class="card">
                <div class="card-header" id="step4Header">
                    <h2>
                        <button id="summary-header-btn" class="btn btn-link collapsed" type="button"
                            data-toggle="collapse" data-target="#step4Content" aria-expanded="false"
                            aria-controls="step4Content">
                            <i class="material-icons-outlined">description</i> Step 4: Summary of Your Input
                        </button>
                    </h2>
                </div>
                <div id="step4Content" class="collapse" aria-labelledby="step4Header" data-parent="#wizardAccordion">

                    <div class="card-body">
                        <table class="table table-bordered">
                            <tbody>
                                <tr>
                                    <th scope="row">Location:</th>
                                    <td id="summary-location">London, UK</td>
                                </tr>
                                <tr>
                                    <th scope="row">Area:</th>
                                    <td id="summary-area-result">1,000m^2</td>
                                </tr>
                                <tr>
                                    <th scope="row">System Capacity (kW):</th>
                                    <td id="summary-capacity">1,000</td>
                                </tr>
                                <tr>
                                    <th scope="row">Array Type:</th>
                                    <td id="summary-array-type">AT</td>
                                </tr>
                                <tr>
                                    <th scope="row">Module Type:</th>
                                    <td id="summary-module-type">MT</td>
                                </tr>
                                <tr>
                                    <th scope="row">Tilt Angle (°):</th>
                                    <td id="summary-tilt">8deg</td>
                                </tr>
                                <tr>
                                    <th scope="row">Azimuth Angle (°):</th>
                                    <td id="summary-azimuth">81deg</td>
                                </tr>
                                <tr>
                                    <th scope="row">System Losses (%):</th>
                                    <td id="summary-losses">e95%</td>
                                </tr>
                            </tbody>
                        </table>
                        <form>
                            <div class="form-group">
                                <button type="button" class="btn btn-primary" id="calculate-btn">Calculate</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>



            <footer>
                <p>by Michael Burgess; inspired by PVWatts</p>
            </footer>
    </main>

    <!-- Include Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>



    <script>

        const userDataElements = [
            'location', 'area-result', 'capacity',
            'array-type', 'module-type', 'tilt', 'azimuth', 'losses',
        ];

        function collateData() {
            const data = {};

            for (const id of userDataElements) {
                data[id] = document.getElementById(id).value;
            }

            return data;
        }


        function showData() {
            const data = collateData();

            for (const id of userDataElements) {
                document
                    .getElementById('summary-' + id)
                    .textContent = data[id];
            }
        }
        const progressBtn = document.getElementById('calculate-btn');

        function fakeProgress() {
            progressBtn.textContent = '0%';

            const intervalID = setInterval(function () {
                if (progressBtn.textContent.includes('Ready')) {
                    clearInterval(intervalID);
                    return;
                }

                if (progressBtn.textContent.includes('%')) {
                    const pc = parseInt(progressBtn.textContent.split('%').at(0));

                    progressBtn.textContent = (pc === 95) ? '..' : `${pc + 5}%`;

                    return;
                }

                progressBtn.textContent += `..`;
            }, 500);
        }

        async function sendData() {
            const data = collateData();
            const url = 'http://127.0.0.1:8000/api/submit-data';

            const req = {
                method: 'GET',
                // mode: "no-cors",
                headers: {
                    'Content-Type': 'text/plain',
                },
                // body: JSON.stringify(data),
            };


            fakeProgress();

            
            fetch(url, req)
                .then(response => {
                    console.log(response);
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    return response.json();
                })
                .then(responseData => {
                    if (responseData.error) {
                        throw new Error('The API reported an error: ' + responseData.error);
                    }

                    progressBtn.textContent = 'Ready! Click to see your results.';
                    progressBtn.style.backgroundColor = 'darkorchid';
                    progressBtn.classList.add('ready-btn');

                    progressBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        window.location.href = window.location.href.replace('home', 'results') + '?resultID=' + responseData.resultID;
                    })
                })
                .catch(error => {
                    console.error('Error:', error);
                });

        }

        document
            .getElementById('calculate-btn')
            .addEventListener('click', sendData);


        document
            .getElementById('summary-header-btn')
            .addEventListener('click', showData);


    </script>


    <script>


        document.getElementById('address-btn').addEventListener('click', (e) => {
            e.preventDefault();

            e.target.style.display = 'none';
            document.getElementById('location').setAttribute('readonly', 'true');

            createLocationMap(
                document.getElementById('location-map'),
                document.getElementById('location').value
            );
        });


        function drawMaps() {
            createLocationMap(document.getElementById('location-map'));
            createDrawingMap(document.getElementById('drawable-map'));
        }

        function createDrawingMap(mapDomElement) {
            const loc = {
                lat: parseFloat(document.getElementById('location_lat').value),
                lng: parseFloat(document.getElementById('location_lng').value),
            };

            console.log(loc);

            const mapOptions = {
                center: loc,
                zoom: 15
            };

            const map = new google.maps.Map(mapDomElement, mapOptions);

            new google.maps.Marker({map: map, position: mapOptions.center});

            const drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: [google.maps.drawing.OverlayType.POLYGON]
                }
            });

            drawingManager.setMap(map);

            var infowindow = new google.maps.InfoWindow();

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function (event) {
                if (event.type === google.maps.drawing.OverlayType.POLYGON) {
                    const area = google.maps.geometry.spherical.computeArea(event.overlay.getPath());
                    document.getElementById('area-result').value = area;

                    document.getElementById('area-result-heading').innerHTML =
                        `Area: ${area.toFixed(2)} m<sup>2</sup>`;
                }
            });
        }

        function createLocationMap(mapDomElement, address = false) {
            const geocoder = new google.maps.Geocoder();
            
            const map = new google.maps.Map(mapDomElement, {
                zoom: 10,
                center: {lat: 52, lng: 0}
            });

            if (!address) return;

            geocoder.geocode({ address: address }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;

                    document.getElementById('location').value = location;
                    document.getElementById('location_lat').value = location.lat();
                    document.getElementById('location_lng').value = location.lng();
                    
                    createDrawingMap(document.getElementById('drawable-map'));

                    map.setCenter(location);

                    new google.maps.Marker({
                        map: map,
                        position: location,
                    });
                } else {
                    console.error('Geocode was not successful for the following reason: ' + status);
                }
            });
        }
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRgDUBmY7ltOsxbNOCb8wMo5SEmSofPGo&libraries=drawing,geometry&callback=drawMaps">
        </script>

</body>

</html>